open C:\Users\XX_daily_data.csv # load data from disk

scalar start_index = 1
scalar window = 252
scalar end_index = nobs(Absolute_Returns) - window

series sliced_Absolute_Returns
series sliced_Negative_Sentiment
series sliced_Media_Volume

series neg_p_values_lag_one
series neg_p_values_lag_two
series neg_p_values_lag_three
series neg_p_values_lag_four
series neg_p_values_lag_five
series count_p_values_lag_one
series count_p_values_lag_two
series count_p_values_lag_three
series count_p_values_lag_four
series count_p_values_lag_five
    
loop i=1..end_index
    print i
    
    # Move the window
    lower_window = i
    upper_window = i + window
    
    # Fill in first values
    loop k=1..window
		neg_p_values_lag_one[k] = 0
		neg_p_values_lag_two[k] = 0
		neg_p_values_lag_three[k] = 0
		neg_p_values_lag_four[k] = 0
		neg_p_values_lag_five[k] = 0
		count_p_values_lag_one[k] = 0
		count_p_values_lag_two[k] = 0
		count_p_values_lag_three[k] = 0
		count_p_values_lag_four[k] = 0
		count_p_values_lag_five[k] = 0
    endloop
    
    # Calculate data in window
	loop j=lower_window..upper_window
	    sliced_Absolute_Returns[j-lower_window+1] = Absolute_Returns[j]
        sliced_Negative_Sentiment[j-lower_window+1] = Stemmed_Negative_Sentiment[j]
        sliced_Media_Volume[j-lower_window+1] = Media_Volume[j]
    endloop
    
    # Save sentiment T-ratios
    var 5 sliced_Absolute_Returns sliced_Negative_Sentiment --robust-hac #--silent

	# Calculate degrees of freedom
	scalar ncoeffs = nelem($coeff)
	df = $nobs - ncoeffs
    
    # Calculate p-values for each coefficent
    t_ratio = abs($coeff[7,1] / $stderr[7,1])
    neg_p_values_lag_one[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[8,1] / $stderr[8,1])
	neg_p_values_lag_two[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[9,1] / $stderr[9,1])
	neg_p_values_lag_three[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[10,1] / $stderr[10,1])
	neg_p_values_lag_four[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[11,1] / $stderr[11,1])
	neg_p_values_lag_five[i+window] = 2 * (pvalue(t, df, t_ratio))
    
    print neg_p_values_lag_one[i+window]
    print neg_p_values_lag_three[i+window]
    print neg_p_values_lag_five[i+window]
    
    var 5 sliced_Absolute_Returns sliced_Media_Volume --robust-hac --silent

	# Calculate degrees of freedom
	scalar ncoeffs = nelem($coeff)
	df = $nobs - ncoeffs

	# Calculate p-values for each coefficent
	t_ratio = abs($coeff[7,1] / $stderr[7,1])
    count_p_values_lag_one[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[8,1] / $stderr[8,1])
	count_p_values_lag_two[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[9,1] / $stderr[9,1])
	count_p_values_lag_three[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[10,1] / $stderr[10,1])
	count_p_values_lag_four[i+window] = 2 * (pvalue(t, df, t_ratio))
	t_ratio = abs($coeff[11,1] / $stderr[11,1])
	count_p_values_lag_five[i+window] = 2 * (pvalue(t, df, t_ratio))

    
endloop

# Save to csv file
store C:\MAI_Results\Absolute_Returns_Rolling_VAR_p_values.csv neg_p_values_lag_one neg_p_values_lag_two neg_p_values_lag_three neg_p_values_lag_four neg_p_values_lag_five count_p_values_lag_one count_p_values_lag_two count_p_values_lag_three count_p_values_lag_four count_p_values_lag_five
